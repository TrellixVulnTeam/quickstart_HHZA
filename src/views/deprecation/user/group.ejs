<!DOCTYPE html>
<html>

<head>
    <title><%= app.name %> - Groups Management</title>
  
    <%# meta  %>
    <% include ../partials/dependencies/meta %>
  
    <%# css dependencies  %>
    <% include ../partials/dependencies/style %>
    <script>
    var storedtimeout;
    function showMsg(message) {
        document.getElementById("showMessage").innerHTML = message;
        document.getElementById('showMessage').style.display = 'inline';
        clearTimeout(storedtimeout);
        storedtimeout = setTimeout(
            function() { document.getElementById('showMessage').style.display = 'none'; },
            3000
        );
    }

    function showError(responseText) {
        var errorReason = JSON.parse(responseText).errors[0];
        showMsg(errorReason);
    }

    // Performs an ajax call to delete group
    // Automatically refreshes all entries in #groupTable when done
    function deleteGroup(groupname) {
		var xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            // Display Success/Failure message
            var success = this.status === 200;
            if (success) showMsg("Success");
            else showError(this.responseText);
            // Refresh table entries
            populateGroupTable();
        };
		xhttp.open('DELETE', '/api/groups/' + groupname);
		xhttp.send();
    }

    // Creates a button that when clicked, calls the deleteGroup() function
    function deleteGroupBtn(groupname) {
        groupname = "'" + groupname + "'";
		var code = '';
		code += '<button onclick="deleteGroup(' + groupname + ')">';
		code += 'Delete';
		code += '</button>';
		return code;
	}

    // Refreshes all entries in #groupTable
	function populateGroupTable() {
		var xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            // Reset table innerHTML
            var table = document.getElementById("groupTable");
            table.innerHTML = "<tr><th>Name</th><th></th></tr>";
            // Dynamically insert row
            var arrayOfRows = JSON.parse(this.responseText);
            arrayOfRows.forEach(rowEntry => {
                var row = table.insertRow(-1);
                row.insertCell(-1).innerHTML = rowEntry.groupname;
                row.insertCell(-1).innerHTML = deleteGroupBtn(rowEntry.groupname);
            });
		};
		xhttp.open("GET", "/api/groups/", true);
		xhttp.send();
	}

    // Perform an ajax call to add group
    // Automatically refreshes all entries in #groupTable when done
    function addGroup() {
        var groupname = document.getElementById("groupname").value;

		var xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            // Display Success/Failure message
            var success = this.status === 201;
            if (success) { showMsg("Success"); }
            else showError(this.responseText);
            // Refresh table entries
            populateGroupTable();
        };
		xhttp.open('POST', '/api/groups/');
        // Prepare POST parameters
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        var params = 'groupname=' + groupname;
		xhttp.send(params);
    }

    function renameGroup() {
        var oldname = document.getElementById('oldname').value;
        var newname = document.getElementById('newname').value;
		var xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            // Display Success/Failure message
            var success = this.status === 201;
            if (success) { showMsg("Success");
            } else if (this.status === 404) {
                showMsg('404 Not found');
            } else {
                showError(this.responseText);
            }
            // Refresh table entries
            populateGroupTable();
        };
		xhttp.open('PUT', '/api/groups/' + oldname);
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		xhttp.send('groupname=' + newname);
    }

  </script>
  <style>
      .flexbox {
          display: flex;
      }
      .flexbox > div {
          margin: 0 10px 0 10px;
          padding: 0 10px 0 10px;
      }
  </style>
</head>

<body onload="populateGroupTable()">

  <div class="wrapper">
    <%# sidebar %>
    <% include ../partials/sidebar %>

    <%# page content  %>
    <div id="content">

      <%# navbar %>
      <% include ../partials/navbar %>

      <div class="content">

        <div class="container-fluid">

          <span>&nbsp</span><span id="showMessage" style='color: red;'></span>

          <div class='flexbox'>
              <div>
                  <h2>Group</h2>
                  <table id="groupTable">
                  </table>
                  <button onclick="populateGroupTable()">Refresh</button>
              </div>
              <div>
      		      <h2>Add Group</h2>
                  <label for="groupname">Group Name:</label>
                  <input type="text" id="groupname"><br>
                  <button onclick='addGroup()'>submit</button>
              </div>
              <div>
                  <h2>Rename Group</h2>
                  <table>
                      <tr>
                          <td><label for="oldname">Group Name:</label></td>
                          <td><input type="text" id="oldname"></td>
                      </tr>
                      <tr>
                          <td><label for="newname">New Name:</label></td>
                          <td><input type="text" id="newname"></td>
                      </tr>
                      <tr>
                          <td></td>
                          <td><button onclick='renameGroup()'>submit</button></td>
                      </tr>
                  </table>
              </div>
         </div>

        </div>

      </div>

    </div>
  </div>

  <%# js dependencies  %>
  <% include ../partials/dependencies/script %>
</body>

</html>
